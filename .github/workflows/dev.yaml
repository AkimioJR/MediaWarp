name: MediaWarp DEV

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"

jobs:
  builder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --snapshot --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push AMD64 Docker Image to My Repository
        run: |
          # 获取 amd64 镜像的完整标签
          AMD64_IMAGE=$(docker images | grep "mediawarp" | grep "amd64" | awk '{print $1":"$2}')
          echo "AMD64 image: $AMD64_IMAGE"
          
          # 提取版本号（去掉-amd64后缀）
          VERSION=$(echo $AMD64_IMAGE | grep -oP '[^:]+$' | sed 's/-amd64//')
          echo "Version: $VERSION"
          
          # 你的 Docker Hub 用户名（从 secret 获取）
          DOCKER_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
          
          # 重新标记镜像到你的仓库
          NEW_IMAGE_TAG="${DOCKER_USERNAME}/mediawarp:${VERSION}"
          echo "New image tag: $NEW_IMAGE_TAG"
          
          docker tag $AMD64_IMAGE $NEW_IMAGE_TAG
          docker push $NEW_IMAGE_TAG

      - name: Upload assets
        uses: actions/upload-artifact@v4
        with:
          path: |
            ./dist/*.zip
            ./dist/*.tar.gz
            ./dist/*.json
            ./dist/*.yaml   ./dist/*.tar.gz
            ./dist/*.json
            ./dist/*.yaml
